<div
    class="flex flex-col gap-4 sm:w-full profile_container"
    style="width: 25rem; height: max-content"
>
    <div
        id="profile_card"
        class="card padded flex flex-col gap-2 w-full"
        style="padding-top: 0; height: max-content"
    >
        <style>
            .profile_avatar {
                --size: 180px;
            }

            .profile_avatar_container {
                margin: -80px auto 0;
            }

            @media screen and (max-width: 900px) {
                .profile_avatar {
                    --size: 160px;
                }

                .profile_avatar_container {
                    margin: -60px auto 0;
                }
            }
        </style>

        <div class="flex flex-col gap-2 profile_card_section_1">
            <div class="flex flex-col gap-2 w-full">
                <div
                    style="position: relative"
                    class="profile_avatar_container"
                >
                    <img
                        title="{{ other.username }}'s avatar"
                        src="/api/v0/auth/profile/{{ other.id }}/avatar"
                        alt=""
                        class="avatar profile_avatar"
                    />

                    <!-- profile crown -->
                    {% if other.tier >= config.tiers.avatar_crown %}
                    <div class="avatar_crown" title="Supporter ❤️">👑</div>
                    {% endif %}
                </div>

                <!-- prettier-ignore -->
                <div id="names">
                    <div class="flex gap-2 items-center" style="max-width: 100%">
                        <h3 class="no-margin username">
                            {% if let Some(display_name) = other.metadata.kv.get("sparkler:display_name") %}
                                {% if !display_name.trim().is_empty() %}
                                    {{ display_name }}
                                {% else %}
                                    {{ other.username }}
                                {% endif %}
                            {% else %}
                                {{ other.username }}
                            {% endif %}
                        </h3>

                        {% let use_static = true %}
                        {% let user = other.clone() %}
                        {% include "components/user_note.html" %}
                    </div>

                    <h4 class="no-margin username" style="font-weight: normal; opacity: 50%">{{ other.username }}</h4>

                    {% if is_following_you == true %}
                    <span class="notification notif-invert ff-inherit fs-md bold">Follows you</span>
                    {% endif %}

                    <div class="flex flex-wrap w-full gap-2">
                        {% for badge in other.badges %}
                        <span
                            class="notification ff-inherit fs-md bold flex items-center justify-center"
                            style="background: {{ badge.1 }}; color: {{ badge.2 }}; gap: 5px"
                        >
                            {{ icon "award" }}
                            {{ badge.0 }}
                        </span>
                        {% endfor %}

                        {% if other.tier >= config.tiers.profile_badge %}
                        <span
                            class="notification ff-inherit fs-md bold flex items-center justify-center"
                            style="background: var(--color-primary); color: var(--color-text-primary); gap: 5px"
                        >
                            {{ icon "crown" }}
                            Supporter
                        </span>
                        {% endif %}

                        {% if other.group == -1 %}
                        <span
                            class="notification ff-inherit fs-md bold flex items-center justify-center"
                            style="background: var(--color-lowered); color: var(--color-text-lowered); gap: 5px"
                        >
                            {{ icon "shield-ban" }}
                            Banned
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2 profile_card_section_1_1">
                <!-- prettier-ignore -->
                <div id="biography">
                    {% if let Some(biography) = other.metadata.kv.get("sparkler:biography") %}
                        {{ rainbeam_shared::ui::render_markdown(biography)|safe }}
                    {% endif %}
                </div>

                <!-- prettier-ignore -->
                {% if let Some(sidebar) = other.metadata.kv.get("sparkler:sidebar") %}
                {% if !sidebar.is_empty() %}
                <div id="sidebar" class="card secondary w-full">
                    {{ rainbeam_shared::ui::render_markdown(sidebar)|safe }}
                </div>
                {% endif %} {% endif %} {% if other.links.len() > 0 %}
                <table id="links">
                    <tbody>
                        {% for (k, v) in other.links %}
                        <tr>
                            <td>
                                <a
                                    href="{{ v }}"
                                    style="display: block; width: 100%"
                                    >{{ k }}</a
                                >
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
        </div>

        <div class="flex flex-col gap-2 profile_card_section_2">
            <!-- buttons -->
            {% if let Some(profile) = profile %} {% if profile.username ==
            other.username %}
            <!-- options for account owner -->
            <!-- <hr /> -->
            <a
                title="Edit Profile"
                class="button w-full bold primary"
                href="/settings/profile"
            >
                <span class="possible_text"
                    >{{ text "profile:base.html:link.edit_profile" }}</span
                >
                {{ icon "pen" }}
            </a>

            <div class="dropdown">
                <button
                    title="More"
                    onclick="trigger('app:hook.dropdown', [event])"
                    exclude="dropdown"
                    class="w-full"
                >
                    <span class="possible_text"
                        >{{ text "general:link.more" }}</span
                    >
                    {{ icon "chevron-down" c(dropdown-arrow) }}
                </button>

                <div class="inner w-content left" exclude="dropdown">
                    <a href="/settings">
                        {{ icon "settings" }} {{ text
                        "profile:base.html:link.account_settings" }}
                    </a>

                    <a
                        href="javascript:document.getElementById('embed_dialog').showModal()"
                    >
                        {{ icon "code" }} {{ text
                        "profile:base.html:link.embed_profile" }}
                    </a>
                </div>
            </div>
            {% else %}
            <div class="flex gap-2">
                <!-- follow, unfollow -->
                {% if !is_following %}
                <button
                    class="w-full bold primary"
                    onclick="follow()"
                    id="follow_button"
                >
                    {{ text "profile:base.html:action.follow" }}
                </button>
                {% else %}
                <button class="w-full" onclick="follow()" id="follow_button">
                    {{ text "profile:base.html:action.unfollow" }}
                </button>
                {% endif %} {% if relationship ==
                crate::model::RelationshipStatus::Unknown %}
                <button class="w-full primary bold" onclick="friend()">
                    {{ text "profile:base.html:action.friend" }}
                </button>

                <script>
                    globalThis.friend = function (username) {
                        fetch(
                            "/api/v0/auth/relationships/friend/{{ other.id }}",
                            {
                                method: "POST",
                            },
                        )
                            .then((res) => res.json())
                            .then((res) => {
                                trigger("app:toast", [
                                    res.success ? "success" : "error",
                                    res.success
                                        ? "Friend request sent!"
                                        : res.message,
                                ]);
                            });
                    };
                </script>
                {% else if relationship ==
                crate::model::RelationshipStatus::Friends %}
                <button class="w-full" onclick="unfriend()">
                    {{ text "profile:base.html:action.unfriend" }}
                </button>

                <script>
                    globalThis.unfriend = async function (username) {
                        if (
                            !(await trigger("app:confirm", [
                                "Are you sure you want to do this?",
                            ]))
                        ) {
                            return;
                        }

                        fetch(
                            "/api/v0/auth/relationships/current/{{ other.id }}",
                            {
                                method: "DELETE",
                            },
                        )
                            .then((res) => res.json())
                            .then((res) => {
                                trigger("app:toast", [
                                    res.success ? "success" : "error",
                                    res.success
                                        ? "User unfriended!"
                                        : res.message,
                                ]);
                            });
                    };
                </script>
                {% else if relationship ==
                crate::model::RelationshipStatus::Pending %}
                <button
                    class="w-full"
                    onclick="cancel_fr()"
                    title="Cancel friend request"
                >
                    {{ text "general:dialog.cancel" }}
                </button>

                <script>
                    globalThis.cancel_fr = async function () {
                        if (
                            !(await trigger("app:confirm", [
                                "Are you sure you want to do this?",
                            ]))
                        ) {
                            return;
                        }

                        fetch(
                            "/api/v0/auth/relationships/current/{{ other.id }}",
                            {
                                method: "DELETE",
                            },
                        )
                            .then((res) => res.json())
                            .then((res) => {
                                trigger("app:toast", [
                                    res.success ? "success" : "error",
                                    res.success
                                        ? "Request cancelled!"
                                        : res.message,
                                ]);

                                window.close();
                            });
                    };
                </script>
                {% endif %}
            </div>

            <!-- actions -->
            <div class="dropdown">
                <button
                    onclick="trigger('app:hook.dropdown', [event])"
                    exclude="dropdown"
                    class="w-full"
                >
                    <span class="possible_text">Actions</span>
                    {{ icon "chevron-down" c(dropdown-arrow) }}
                </button>

                <div class="inner w-content left" exclude="dropdown">
                    <b class="title">This user</b>
                    <button
                        onclick="trigger('chats:create', ['{{ other.id }}'])"
                    >
                        {{ icon "message-circle-plus" }} {{ text
                        "general:link.chat" }}
                    </button>
                    <a href="/inbox/mail/compose?to={{ other.id }}">
                        {{ icon "mail-plus" }} {{ text "general:service.mail" }}
                    </a>
                    <a
                        href="/settings?block={{ other.username }}#sparkler:block_somebody"
                        target="_blank"
                    >
                        {{ icon "shield" }} {{ text "general:action.block" }}
                    </a>
                    <a
                        href="javascript:trigger('reports:bootstrap', ['profiles', '{{ other.username }}'])"
                    >
                        {{ icon "flag" }} {{ text "general:action.report" }}
                    </a>
                    <a
                        href="#"
                        onclick="trigger('app:copy_text', ['{{ other.id }}'])"
                    >
                        {{ icon "copy" }} {{ text "general:action.copy_id" }}
                    </a>
                    {% if is_powerful %}
                    <!-- for managers ONLY -->
                    <a href="javascript:delete_account()">
                        {{ icon "trash" }} {{ text "general:action.delete" }}
                    </a>

                    <script>
                        function delete_account() {
                            if (!confirm("Are you sure you want to do this?")) {
                                return;
                            }

                            fetch("/api/v0/auth/profile/{{ other.id }}", {
                                method: "DELETE",
                            })
                                .then((res) => res.json())
                                .then((res) => {
                                    trigger("app:shout", [
                                        res.success ? "tip" : "caution",
                                        res.message || "Profile deleted!",
                                    ]);

                                    e.target.reset();
                                });
                        }
                    </script>
                    {% endif %}
                    <b class="title">Your account</b>
                    <a href="/settings#sparkler:blocks">
                        {{ icon "lock" }} {{ text
                        "profile:base.html:link.manage_blocks" }}
                    </a>
                </div>
            </div>
            {% endif %} {% else %}
            <!-- anonymous actions -->
            <div class="dropdown">
                <button
                    onclick="trigger('app:hook.dropdown', [event])"
                    exclude="dropdown"
                    class="w-full"
                >
                    {{ text "general:link.actions" }} {{ icon "chevron-down"
                    c(dropdown-arrow) }}
                </button>

                <div class="inner w-content left" exclude="dropdown">
                    <b class="title"
                        >{{ text "profile:base.html:title.this_user" }}</b
                    >
                    <a
                        href="javascript:trigger('reports:bootstrap', ['profiles', '{{ other.username }}'])"
                    >
                        {{ icon "flag" }} {{ text "general:action.report" }}
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <hr class="mobile small" />
</div>
