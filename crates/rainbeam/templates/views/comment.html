{% extends "base.html" %} {% block title %}{{ config.name }}{% endblock %} {%
block head %}
<meta name="description" content="{{ config.description }}" />
{% endblock %} {% block nav_left %} {% if profile.is_some() %}
<a class="button" href="/" title="Timeline">
    <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        width="18"
        height="18"
        aria-label="Home symbol"
        class="icon"
    >
        <path
            d="M12.97 2.59a1.5 1.5 0 0 0-1.94 0l-7.5 6.363A1.5 1.5 0 0 0 3 10.097V19.5A1.5 1.5 0 0 0 4.5 21h4.75a.75.75 0 0 0 .75-.75V14h4v6.25c0 .414.336.75.75.75h4.75a1.5 1.5 0 0 0 1.5-1.5v-9.403a1.5 1.5 0 0 0-.53-1.144l-7.5-6.363Z"
        ></path>
    </svg>
    <span class="desktop">Timeline</span>
    <span class="mobile">Home</span>
</a>

<a class="button" href="/inbox" title="My inbox">
    <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 16 16"
        width="16"
        height="16"
        aria-label="Inbox symbol"
        class="icon"
    >
        <path
            d="M2.8 2.06A1.75 1.75 0 0 1 4.41 1h7.18c.7 0 1.333.417 1.61 1.06l2.74 6.395c.04.093.06.194.06.295v4.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25v-4.5c0-.101.02-.202.06-.295Zm1.61.44a.25.25 0 0 0-.23.152L1.887 8H4.75a.75.75 0 0 1 .6.3L6.625 10h2.75l1.275-1.7a.75.75 0 0 1 .6-.3h2.863L11.82 2.652a.25.25 0 0 0-.23-.152Zm10.09 7h-2.875l-1.275 1.7a.75.75 0 0 1-.6.3h-3.5a.75.75 0 0 1-.6-.3L4.375 9.5H1.5v3.75c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25Z"
        ></path>
    </svg>
    <span class="flex items-center gap-2">
        <span>Inbox</span>
        {% if unread != 0 %}
        <span class="notification tr">{{ unread }}</span>
        {% endif %}
    </span>
</a>
{% endif %} {% endblock %} {% block nav_right %} {% if profile.is_some() %}
<a class="button" href="/inbox/notifications" title="My notifications">
    <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 16 16"
        width="16"
        height="16"
        aria-label="Bell symbol"
        class="icon"
    >
        <path
            d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM3 5a5 5 0 0 1 10 0v2.947c0 .05.015.098.042.139l1.703 2.555A1.519 1.519 0 0 1 13.482 13H2.518a1.516 1.516 0 0 1-1.263-2.36l1.703-2.554A.255.255 0 0 0 3 7.947Zm5-3.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.017.017 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"
        ></path>
    </svg>
    {% if notifs != 0 %}
    <span class="notification tr">{{ notifs }}</span>
    {% endif %}
</a>
{% endif %} {% endblock %} {% block content %}
<article>
    <main class="flex flex-col gap-2">
        <!-- response -->
        {% if comment.0.reply.is_none() %}
        <h5 id="response" class="flex items-center gap-1">
            Response
            <a title="Unfold comment" href="/response/{{ response.1.id }}">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 16 16"
                    width="16"
                    height="16"
                    aria-label="Unfold symbol"
                    class="icon"
                >
                    <path
                        d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"
                    ></path>
                </svg>
            </a>
        </h5>
        <!-- show original response -->
        <!-- prettier-ignore -->
        {% let is_pinned = false %}
        {% let show_pin_button = false %}
        {% let do_not_render_question = false %}
        {% let response = (question.clone(), response.clone(), 0, reaction_count) %}
        {% let show_comments = false %}
        {% let do_render_nested = true %}
        {% include "components/response.html" %}
        {% endif %}

        <!-- reply -->
        <!-- prettier-ignore -->
        {% if let Some(comment) = comment.0.reply %}
        {% let comment = (comment, 0, 0) %}
        <h5 id="comment" class="flex items-center gap-1">
            Replying to
            <a title="Unfold comment" href="/comment/{{ comment.0.id }}">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 16 16"
                    width="16"
                    height="16"
                    aria-label="Unfold symbol"
                    class="icon"
                >
                    <path
                        d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"
                    ></path>
                </svg>
            </a>
        </h5>
        {% let show_replies = false %} {% include "components/comment.html" %}
        {% endif %}

        {% if is_powerful %}
        <div class="question_ip card shadow round">
            <a href="/+i/{{ comment.0.ip }}">{{ comment.0.ip }}</a>
        </div>
        {% endif %}

        <!-- single comment -->
        <div class="flex gap-4">
            <div class="thread_line"></div>
            <div class="flex flex-col gap-2 w-full">
                <h5 id="comment">Comment</h5>
                {% let show_replies = false %} {% include
                "components/comment.html" %}
            </div>
        </div>

        <!-- reactions -->
        <hr />
        <h5 id="reactions">Reactions</h5>
        <div id="reactions" class="flex gap-2 flex-wrap w-full">
            {% for reaction in reactions %}
            <a href="/@{{ reaction.user.username }}">
                <img
                    title="{{ reaction.user.username }}'s avatar"
                    src="/api/v0/auth/profile/{{ reaction.user.id }}/avatar"
                    alt="@{{ reaction.user.username }}"
                    class="avatar"
                loading="lazy"
                    style="--size: 20px"
                />
            </a>
            {% endfor %}
        </div>

        <!-- replies -->
        <hr />
        <h5 id="replies">Replies</h5>
        <div class="card-nest w-full" id="comment_field">
            <div class="card flex flex-col gap-1">Add a reply</div>

            <div class="card">
                <form
                    class="flex flex-col gap-2"
                    onsubmit="comment(event, '{{ response.id }}')"
                >
                    {% if let Some(profile) = profile %}
                    <textarea
                        class="w-full"
                        placeholder="Type your reply!"
                        minlength="1"
                        maxlength="{% if profile.tier >= config.tiers.double_limits %}4096{% else %}2048{% endif %}"
                        required
                        name="content"
                        id="content"
                        hook="counter"
                    ></textarea>
                    {% else %}
                    <textarea
                        class="w-full"
                        placeholder="Type your reply!"
                        minlength="1"
                        maxlength="2048"
                        required
                        name="content"
                        id="content"
                        hook="counter"
                    ></textarea>
                    {% endif %}

                    <div class="flex justify-between w-full gap-1">
                        <div class="flex gap-2 items-center">
                            <span
                                id="content:counter"
                                class="notification item"
                            ></span>

                            <div class="checkbox_container item">
                                <input
                                    type="checkbox"
                                    name="anonymous"
                                    id="anonymous"
                                />

                                <label for="anonymous" class="normal">
                                    Hide your name
                                </label>
                            </div>

                            <script>
                                function ls_anon_check() {
                                    if (
                                        window.localStorage.getItem(
                                            "always_anon",
                                        ) === "true"
                                    ) {
                                        document.getElementById(
                                            "anonymous",
                                        ).checked = true;
                                    }
                                }

                                ls_anon_check();
                            </script>
                        </div>

                        <button class="primary bold">Submit</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- prettier-ignore -->
        {% for reply in replies %}
            {% let comment = reply %}
            {% let show_replies = true %}
            {% include "components/comment.html" %}
        {% endfor %}

        <!-- pagination buttons -->
        <div class="flex justify-between gap-2 w-full">
            {% if page > 0 %}
            <a class="button secondary" href="?page={{ page - 1 }}">Previous</a>
            {% else %}
            <div></div>
            {% endif %} {% if replies.len() != 0 %}
            <a class="button secondary" href="?page={{ page + 1 }}">Next</a>
            {% endif %}
        </div>
    </main>
</article>

<script>
    setTimeout(() => {
        trigger("questions:carp");
    }, 100);

    function comment(e, response) {
        e.preventDefault();

        trigger("comments:create", [
            response,
            e.target.content.value,
            "{{ comment.0.id }}",
            e.target.anonymous.checked,
        ]).then((_) => {
            // reset if successful
            e.target.reset();
        });
    }
</script>

{% if let Some(profile) = profile %} {% let other = profile.clone() %} {% if
profile.username == other.username %}
<script src="https://unpkg.com/codemirror@5.39.2/lib/codemirror.js"></script>
<script src="https://unpkg.com/codemirror@5.39.2/addon/display/placeholder.js"></script>
<script src="https://unpkg.com/codemirror@5.39.2/mode/markdown/markdown.js"></script>

<link
    rel="stylesheet"
    href="https://unpkg.com/codemirror@5.39.2/lib/codemirror.css"
/>

<div id="is_self"></div>
<dialog id="edit_dialog">
    <form
        class="inner flex flex-col gap-2"
        onsubmit="edit(event)"
        style="width: 35rem"
    >
        <!-- prettier-ignore -->
        <script type="text/markdown" id="existing_content">{{ comment.0.content.replace("</script>","</not-script>")|safe }}</script>

        <label for="edit_content">New content</label>
        <div id="comment_editor" class="post_editor"></div>

        <script>
            setTimeout(() => {
                use("codemirror", (codemirror) => {
                    codemirror.create_editor(
                        document.getElementById("comment_editor"),
                        document.getElementById("existing_content").innerText,
                        "Type your comment...",
                        "comment_editor_",
                    );
                });
            }, 500);
        </script>

        <hr />
        <div class="flex gap-2">
            <button class="primary bold">Confirm</button>
            <button
                class="bold"
                onclick="document.getElementById('edit_dialog').close(); window.close()"
                type="button"
            >
                Cancel
            </button>
        </div>
    </form>
</dialog>

<script>
    setTimeout(() => {
        const dialogs = ns("dialogs");
        dialogs.add("edit_dialog");

        if (window.location.search === "?edit") {
            dialogs.get("edit_dialog").open();
        }
    }, 100);

    function edit(e) {
        e.preventDefault();
        trigger("comments:edit", [
            "{{ comment.0.id }}",
            globalThis.comment_editor_.getValue(),
        ]).then((res) => {
            alert(res.message || "Comment edited!");

            if (res.success === true) {
                window.close();

                setTimeout(() => {
                    window.location.href = "?";
                }, 100);
            }
        });
    }
</script>
{% endif %} {% let raw_metadata =
crate::routing::pages::clean_metadata_raw(other.metadata) %} {% include
"components/theming.html" %} {% endif %} {% call super() %} {% endblock %}
