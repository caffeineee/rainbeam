{% let reply_count = comment.1 %} {% let reaction_count = comment.2 %} {% let
comment = comment.0.clone() %}
<div
    class="card shadow flex flex-rev-col gap-1 comment_body"
    id="comment:{{ comment.id }}"
>
    <!-- prettier-ignore -->
    <span class="comment_content" hook="long">
        {{ shared::ui::render_markdown(comment.content)|safe }}
    </span>

    <div
        class="flex justify-between flex-collapse sm:items-start items-center gap-1 comment_title"
    >
        <div class="footernav items-center">
            <b class="flex items-center gap-2 item">
                <!-- prettier-ignore -->
                {% let author_tag = crate::database::Database::anonymous_tag(comment.author.username.as_ref()) %}
                {% if author_tag.0 == false %}
                <a
                    href="/@{{ comment.author.username }}"
                    style="color: inherit"
                    class="username flex gap-2 items-center"
                >
                    <img
                        title="{{ comment.author.username }}'s avatar"
                        src="/api/v0/auth/profile/{{ comment.author.id }}/avatar"
                        alt=""
                        class="avatar"
                        loading="lazy"
                        style="--size: 20px"
                    />

                    <!-- prettier-ignore -->
                    {% let display_name = comment.author.metadata.kv.get("sparkler:display_name") %}

                    {% if let Some(display_name) = display_name %}
                        {% if !display_name.trim().is_empty() %}
                            {{ crate::routing::pages::escape_username(display_name) }}
                        {% else %}
                            {{ comment.author.username }}
                        {% endif %}
                    {% else %}
                        {{ comment.author.username }}
                    {% endif %}
                </a>
                {% else %}
                <img
                    title="{{ comment.author.username }}'s avatar"
                    src="/static/images/default-avatar.svg"
                    alt=""
                    class="avatar"
                    loading="lazy"
                    style="--size: 20px"
                />

                <span>anonymous</span>

                <!-- prettier-ignore -->
                {% if is_powerful %}
                {% let author_tag = crate::database::Database::anonymous_tag(comment.author.id.as_ref()) %}
                {% if author_tag.0 %}
                <a class="notification" href="/+u/{{ author_tag.1 }}">
                    {% if author_tag.1.contains("-") %}
                    <span title="User hiding as anonymous">ðŸ¤«</span>
                    {% endif %}
                    <!-- prettier-ignore -->
                    {% if author_tag.1.len() >= 10 %}
                        {{ author_tag.1[..10] }}
                    {% else %}
                        {{ author_tag.1 }}
                    {% endif %}
                </a>
                {% endif %} {% endif %} {% endif %}
            </b>

            <span class="flex fade">
                {% if (comment.edited != 0) && (comment.edited !=
                comment.timestamp) %}
                <span class="date item">{{ comment.edited }}</span>
                <sup title="Edited">*</sup>
                {% else %}
                <span class="date item">{{ comment.timestamp }}</span>
                {% endif %}
            </span>
        </div>

        <div class="flex justify-between gap-2 sm:w-full actions_bar">
            <!-- reactions -->
            <button
                title="{{ reaction_count }} reactions"
                class="camo circle"
                onclick="trigger('reactions:toggle', ['{{ comment.id }}', 'Comment', event.target])"
                hook="check_reaction"
                hook-arg:id="{{ comment.id }}"
            >
                <i class="icon" data-lucide="heart"></i>

                {% if reaction_count > 0 %}
                <span class="notification camo">{{ reaction_count }}</span>
                {% endif %}
            </button>

            <!-- replies -->
            {% if show_replies != false %}
            <a
                href="/comment/{{ comment.id }}"
                title="{{ reply_count }} replies"
                class="button camo circle"
            >
                <i class="icon" data-lucide="message-circle"></i>

                {% if reply_count > 0 %}
                <span class="notification camo">{{ reply_count }}</span>
                {% endif %}
            </a>
            {% endif %}

            <!-- options -->
            <div class="dropdown">
                <button
                    onclick="trigger('app:hook.dropdown', [event])"
                    exclude="dropdown"
                    class="w-full camo circle"
                >
                    <i class="icon" data-lucide="ellipsis"></i>
                </button>

                <div class="inner shadow-md w-content" exclude="dropdown">
                    <b class="title">Sharing</b>

                    <!-- prettier-ignore -->
                    {% let short_id = comment.id[..10] %}

                    <button
                        onclick="trigger('app:copy_text', ['{{ config.host }}/+c/{{ short_id }}'])"
                    >
                        <i class="icon" data-lucide="copy"></i>
                        Copy link
                    </button>

                    {% if let Some(profile) = profile %} {% if (profile.id ==
                    comment.author.id) | (profile.id == response.author.id) %}
                    <!-- actions for the comment author/response author only -->
                    <b class="title">Manage</b>

                    <a href="/comment/{{ comment.id }}?edit" target="_blank">
                        <i class="icon" data-lucide="pen"></i>
                        Edit
                    </a>

                    <a
                        href="#"
                        onclick="trigger('comments:delete', ['{{ comment.id }}'])"
                        class="red"
                    >
                        <i class="icon" data-lucide="trash"></i>
                        Delete
                    </a>

                    <a
                        href="javascript:trigger('comments:ipblock', ['{{ comment.id }}'])"
                    >
                        <i class="icon" data-lucide="shield"></i>
                        IP block
                    </a>
                    {% endif %} {% endif %}
                    <!-- actions for everybody -->
                    <b class="title">Tools</b>
                    <a
                        href="#"
                        onclick="trigger('app:copy_text', ['{{ comment.id }}'])"
                    >
                        <i class="icon" data-lucide="copy"></i>
                        Copy ID
                    </a>

                    <a href="/comment/{{ comment.id }}">
                        <i class="icon" data-lucide="external-link"></i>
                        Open
                    </a>

                    <!-- prettier-ignore -->
                    {% if let Some(profile) = profile %}
                    {% if profile.id != comment.author.id %}
                    <!-- actions for users that ARE NOT the author -->
                    <a
                        href="javascript:trigger('reports:bootstrap', ['comments', '{{ comment.id }}'])"
                    >
                        <i class="icon" data-lucide="flag"></i>
                        Report
                    </a>
                    {% endif %} {% if is_helper %}
                    <b class="title">Mod</b>
                    <a
                        href="#"
                        onclick="trigger('comments:delete', ['{{ comment.id }}'])"
                        class="red"
                    >
                        <i class="icon" data-lucide="trash"></i>
                        Delete
                    </a>
                    {% endif %} {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .comment_body {
        border-radius: var(--radius) !important;
    }
</style>
